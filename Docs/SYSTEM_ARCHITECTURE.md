# Повна модульна архітектура ModuChill

## Огляд

Система ModuChill побудована на принципах повної модульності та розширюваності. Кожен компонент системи є самодостатнім модулем, який можна легко додати, видалити або замінити без впливу на інші частини системи.

## Основні принципи

1. **Модульність** - кожен функціональний блок є окремим компонентом
2. **Розширюваність** - додавання нових типів без зміни існуючого коду
3. **Ізоляція** - компоненти взаємодіють через чітко визначені інтерфейси
4. **Конфігурованість** - поведінка визначається JSON конфігурацією

## Архітектура системи

```
┌─────────────────────────────────────────────────────────────────┐
│                         Application Layer                        │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────────────────┐ │
│  │ClimateControl│  │DefrostControl│  │   Other Business      │ │
│  │   Module     │  │    Module    │  │     Logic Modules     │ │
│  └──────┬───────┘  └──────┬───────┘  └───────────┬───────────┘ │
│         │                  │                      │              │
└─────────┼──────────────────┼──────────────────────┼──────────────┘
          │                  ▼                      │
          │         ┌─────────────────┐            │
          └────────▶│   SharedState   │◀───────────┘
                    │  (Data Exchange) │
                    └─────┬───────┬───┘
                          │       │
          ┌───────────────┘       └───────────────┐
          ▼                                       ▼
┌──────────────────┐                    ┌──────────────────┐
│  SensorModule    │                    │  ActuatorModule  │
│                  │                    │                  │
│ ┌──────────────┐ │                    │ ┌──────────────┐ │
│ │Driver Registry│ │                    │ │Driver Registry│ │
│ └──────┬───────┘ │                    │ └──────┬───────┘ │
│        ▼         │                    │        ▼         │
│ • DS18B20        │                    │ • RelayDriver    │
│ • NTC            │                    │ • PwmDriver      │
│ • Pressure       │                    │ • GpioOutput     │
│ • GpioInput      │                    │ • StepperDriver  │
└────────┬─────────┘                    └────────┬─────────┘
         │                                       │
         └───────────────┬───────────────────────┘
                         ▼
                 ┌───────────────┐
                 │      HAL      │
                 │               │
                 │ • GPIO        │
                 │ • OneWire     │
                 │ • ADC         │
                 │ • PWM         │
                 └───────────────┘
```

## Компоненти системи

### 1. HAL (Hardware Abstraction Layer)

**Призначення**: Ізоляція апаратури від решти системи

**Ключові особливості**:
- Надає уніфіковані інтерфейси для апаратних ресурсів
- Конфігурується через board_config.h для різних плат
- Не містить бізнес-логіки

**Інтерфейси**:
- `IGpioOutput` - цифрові виходи
- `IGpioInput` - цифрові входи
- `IOneWireBus` - шина OneWire
- `IAdcChannel` - АЦП канали

### 2. SensorModule

**Призначення**: Збір даних з усіх датчиків

**Архітектура**:
```
SensorModule
    ├── SensorDriverRegistry
    └── Drivers/
        ├── DS18B20Driver
        ├── NTCDriver
        ├── PressureDriver
        └── GpioInputDriver
```

**Процес роботи**:
1. Читає конфігурацію з sensors.json
2. Створює драйвери через реєстр
3. Періодично опитує датчики
4. Публікує дані в SharedState

### 3. ActuatorModule

**Призначення**: Керування виконавчими механізмами

**Архітектура**:
```
ActuatorModule
    ├── ActuatorDriverRegistry
    └── Drivers/
        ├── RelayDriver
        ├── PwmDriver
        ├── GpioOutputDriver
        └── StepperDriver
```

**Процес роботи**:
1. Читає конфігурацію з actuators.json
2. Створює драйвери через реєстр
3. Підписується на команди в SharedState
4. Виконує команди та публікує статус

### 4. SharedState

**Призначення**: Централізований обмін даними

**Ключові особливості**:
- Pub/Sub механізм
- JSON формат даних
- Неблокуюча робота

**Простори імен**:
- `state.sensor.*` - дані датчиків
- `state.actuator.*` - статус актуаторів
- `command.actuator.*` - команди керування
- `config.*` - конфігураційні параметри

### 5. Модулі бізнес-логіки

**Приклад - ClimateControl**:
```cpp
// Читає температуру
auto temp = SharedState::get("state.sensor.chamber_temp");

// Аналізує та приймає рішення
if (temp > setpoint + hysteresis) {
    // Вмикає компресор
    SharedState::set("command.actuator.compressor", true);
}
```

## Додавання нових компонентів

### Новий тип датчика

1. **Створити драйвер**:
```
components/sensor_drivers/my_sensor/
├── include/my_sensor_driver.h
├── src/my_sensor_driver.cpp
└── CMakeLists.txt
```

2. **Реалізувати інтерфейс ISensorDriver**

3. **Зареєструвати драйвер**:
```cpp
static SensorDriverRegistrar<MySensorDriver> registrar("MY_SENSOR");
```

4. **Додати в конфігурацію**:
```json
{
  "role": "my_measurement",
  "type": "MY_SENSOR",
  "config": { /* параметри */ }
}
```

### Новий тип актуатора

Процес аналогічний, але реалізується інтерфейс IActuatorDriver.

## Переваги архітектури

### 1. Модульність
- Кожен драйвер - окремий компонент
- Легке включення/виключення через menuconfig
- Немає залежностей між драйверами

### 2. Розширюваність
- Додавання нових типів без зміни ядра
- Підтримка сторонніх драйверів
- Можливість OTA оновлень окремих модулів

### 3. Тестованість
- Кожен модуль тестується окремо
- Mock об'єкти для HAL інтерфейсів
- Інтеграційні тести через SharedState

### 4. Масштабованість
- Додавання нових датчиків/актуаторів
- Розподілена архітектура (можливість multi-MCU)
- Оптимізація пам'яті через вибіркову компіляцію

## Конфігурація системи

### Kconfig
```
menuconfig
├── Sensor Drivers
│   ├── Enable DS18B20
│   ├── Enable NTC
│   └── Enable Pressure
├── Actuator Drivers
│   ├── Enable Relay
│   ├── Enable PWM
│   └── Enable Stepper
└── Business Logic
    ├── Enable Climate Control
    ├── Enable Defrost Control
    └── Enable Alarm System
```

### JSON конфігурація
- `sensors.json` - конфігурація датчиків
- `actuators.json` - конфігурація актуаторів
- `climate.json` - параметри клімат-контролю
- `system.json` - системні налаштування

## Висновок

Модульна архітектура ModuChill забезпечує:
- ✅ Легке додавання нових функцій
- ✅ Підтримку різних апаратних конфігурацій
- ✅ Просту адаптацію під різні застосування
- ✅ Високу надійність та тестованість
- ✅ Готовність до майбутніх розширень

Система готова для використання в промислових холодильних установках з можливістю адаптації під конкретні вимоги замовника!